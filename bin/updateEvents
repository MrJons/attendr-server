#! /app/.heroku/node/bin/node
var request = require('request');
var models = require('../models/index');
var env = require('node-env-file');

if (process.env.NODE_ENV !== "production"){
  env(".env");
}

function updateEvents() {
  return new Promise(function(resolve, reject) {
    request('https://api.meetup.com/find/events?key=' + process.env.API_KEY + '&lat=51.5074&lon=0.1278', function(error, response, body) {
      body = JSON.parse(body);
      async_iterate(body, resolve)
    });
  });
}

function async_iterate(collection, callback) {
  var inserted = 0;
  for(var i = 0; i < collection.length; i++) {
    createEvent(collection[i], function() {
      if (++inserted == collection.length) {
        callback();
      }
    });
  }
}

function createEvent(event, callback){
  models.Event.create(makeEvent(event)).then(function(){callback()});
}

function makeEvent(event){
  var address = (event.venue ? event.venue.address_1 : "London");
  var description = (event.description ? event.description : "Unknown" );
  return {
    name: event.name,
    description: description,
    address: address,
    date: new Date(parseInt(event.time)),
    link: event.link,
    meetup_id: event.id
  }
}

exports.updateEvents = updateEvents;

updateEvents();
